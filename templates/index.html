<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asistente Virtual para Ni√±os</title>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #FFCE00;
      --secondary: #FF6F61;
      --accent: #4A90E2;
      --bg: linear-gradient(to bottom, #E8F6FF, #B3E5FC);
      --text-dark: #333333;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Baloo 2', cursive;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      min-height: 100vh;
      padding: 20px;
      overflow: hidden;
      position: relative;
    }

    header { text-align: center; margin-bottom: 10px; z-index: 2; }
    header h1 {
      font-size: 3rem;
      color: var(--secondary);
      text-shadow: 2px 2px rgba(0,0,0,0.1);
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      position: relative;
      z-index: 2;
    }

    #respuesta {
      font-size: 1.8rem;
      color: var(--text-dark);
      background-color: #fff;
      padding: 15px 20px;
      border-radius: 20px;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      min-height: 60px;
      z-index: 2;
    }

    #imagenes-respuesta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 20px;
      z-index: 2;
    }

    #imagenes-respuesta img {
      width: 160px;
      height: 160px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      background: white;
      padding: 5px;
    }

    .boton-microfono {
      background: var(--primary);
      border: 8px solid var(--secondary);
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      z-index: 2;
    }

    .boton-microfono img { width: 60px; height: 60px; }

    #btn-grabar-intento {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 1.2rem;
      border: none;
      border-radius: 12px;
      background: var(--secondary);
      color: white;
      font-family: 'Baloo 2', cursive;
      cursor: pointer;
      display: none;
    }

    #mensaje-validacion {
      margin-top: 15px;
      font-size: 1.3rem;
      text-align: center;
      color: var(--text-dark);
      font-weight: bold;
    }

    footer { margin-top: 10px; font-size: 1rem; color: var(--text-dark); z-index: 2; }

    /* Nubes */
    .nube-fondo {
      position: absolute;
      width: 150px;
      opacity: 0.3;
      animation: moverNube 25s linear infinite;
      z-index: 0;
    }
    .nube1 { top: 10%; left: -20%; }
    .nube2 { top: 50%; left: -25%; animation-duration: 30s; }

    @keyframes moverNube {
      0% { transform: translateX(0); }
      100% { transform: translateX(150vw); }
    }
    /* Personajes laterales */
    .personaje-lateral {
      position: absolute;
      width: 120px;
      animation: saltar 2s infinite alternate ease-in-out;
      z-index: 1;
    }
    .izq1 { bottom: 10%; left: 2%; }
    .izq2 { top: 10%; left: 2%; }
    .der1 { bottom: 10%; right: 2%; }
    .der2 { top: 10%; right: 2%; }

    @keyframes saltar {
      0% { transform: translateY(0); }
      100% { transform: translateY(-15px); }
    }
    /* Globos flotando */
    .globo {
      position: absolute;
      width: 60px;
      animation: flotar 6s ease-in-out infinite;
      z-index: 0;
    }
    .globo1 { left: 10%; bottom: -80px; animation-delay: 0s; }
    .globo2 { left: 50%; bottom: -100px; animation-delay: 2s; }
    .globo3 { right: 10%; bottom: -120px; animation-delay: 4s; }

    @keyframes flotar {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-120vh) scale(1.2); opacity: 0; }
    }
  </style>
</head>
<body>
  <!-- Nubes -->
  <img src="https://cdn-icons-png.flaticon.com/512/414/414927.png" class="nube-fondo nube1" alt="Nube">
  <img src="https://cdn-icons-png.flaticon.com/512/414/414927.png" class="nube-fondo nube2" alt="Nube">

  <!-- Personajes laterales -->
  <img src="https://cdn-icons-png.flaticon.com/512/5333/5333073.png" class="personaje-lateral izq1" alt="Ni√±o">
  <img src="https://png.pngtree.com/png-clipart/20230914/original/pngtree-preschool-free-vector-png-image_11243424.png" class="personaje-lateral izq2" alt="Ni√±a">
  <img src="https://img.freepik.com/iconos-gratis/trineo_318-680270.jpg" class="personaje-lateral der1" alt="Ni√±o">
  <img src="https://th.bing.com/th/id/R.bb84601a4859b26e40fd19955575e56a?rik=vcwcAMGdquojog&pid=ImgRaw&r=0" class="personaje-lateral der2" alt="Ni√±a">

  <!-- Globos flotando -->
  <img src="https://cdn-icons-png.flaticon.com/512/2132/2132255.png" class="globo globo1" alt="Globo">
  <img src="https://th.bing.com/th/id/R.a57c80755be708ebdaa251f4c98a4bff?rik=id9MqXI%2fyRM%2f5A&pid=ImgRaw&r=0" class="globo globo2" alt="Globo">
  <img src="https://cdn-icons-png.flaticon.com/512/2784/2784389.png" class="globo globo3" alt="Globo">

 
<header>
    <h1>üëã ¬°Hola, amiguito!</h1>
    <p style="font-size:1.2rem;color:var(--text-dark)">Pregunta lo que quieras con tu voz</p>
</header>
<main>
    <div id="respuesta">üéôÔ∏è ¬°Presiona el micr√≥fono para hablar!</div>
    <div id="imagenes-respuesta"></div>
    <button class="boton-microfono" id="microfono" aria-label="Micr√≥fono">
        <img src="https://cdn-icons-png.flaticon.com/512/2377/2377812.png" alt="Micr√≥fono"/>
    </button>
    <button id="btn-grabar-intento">üé§ Graba para repetir</button>
    <div id="mensaje-validacion"></div>
    <div id="contenedor-ejercicios" style="display:none;">
        <button id="btn-frases">üó£Ô∏è Practicar Palabras (A, E, I, O, U)</button>
        <button id="btn-oraciones">üî† Practicar Oraciones</button>
    </div>
    <audio id="audio-respuesta" playsinline></audio>
    <audio id="audio-repeticion" playsinline></audio>
</main>
<footer>
    <p>¬°Habla y descubre!</p>
</footer>
<script>
const botonMicrofono = document.getElementById("microfono");
const respuestaElemento = document.getElementById("respuesta");
const imagenesContenedor = document.getElementById("imagenes-respuesta");
const btnGrabarIntento = document.getElementById("btn-grabar-intento");
const mensajeValidacion = document.getElementById("mensaje-validacion");
const contenedorEjercicios = document.getElementById("contenedor-ejercicios");
const btnFrases = document.getElementById("btn-frases");
const btnOraciones = document.getElementById("btn-oraciones");
const esMovil = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
const opcionesAudio = { mimeType: "audio/webm" };
// const audioIOS = document.getElementById("audioIOS");
// const esIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  
let palabrasPendientes = [];
let palabrasCompletadas = 0;
let mediaRecorder;
let mediaRecorderIntento;
let audioChunks = [];
let audioChunksIntento = [];
  
  
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
  respuestaElemento.innerText = "‚ùå Tu navegador no permite usar el micr√≥fono";
}


  // --- NUEVA L√ìGICA DE GRABACI√ìN DIRECTA ---
botonMicrofono.addEventListener("click", async () => {
  // Si ya estamos grabando, detenemos
  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
    botonMicrofono.style.background = "var(--primary)"; // Vuelve a color amarillo
    return;
  }

  // Si no estamos grabando, iniciamos
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
    // Detectamos si es iPhone para el formato de audio
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const mimeType = isSafari ? 'audio/mp4' : 'audio/webm';
    
    mediaRecorder = new MediaRecorder(stream, { mimeType });
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    
    mediaRecorder.onstop = () => {
      const blob = new Blob(audioChunks, { type: mimeType });
      const ext = isSafari ? 'mp4' : 'webm';
      enviarAudio(blob, `grabacion.${ext}`);
    };

    mediaRecorder.start();
    botonMicrofono.style.background = "red"; // Cambia a rojo grabando
    respuestaElemento.innerText = "üéôÔ∏è Escuchando... Presiona de nuevo para parar";
  } catch (err) {
    respuestaElemento.innerText = "‚ùå Permite el uso del micr√≥fono";
  }
});
// --- GRABACI√ìN PRINCIPAL ---
    botonMicrofono.addEventListener("click", async () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        botonMicrofono.style.background = "var(--primary)";
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';
        mediaRecorder = new MediaRecorder(stream, { mimeType });
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks, { type: mimeType });
          enviarAudio(blob, "grabacion.audio");
        };
        mediaRecorder.start();
        botonMicrofono.style.background = "red";
        respuestaElemento.innerText = "üéôÔ∏è Escuchando...";
      } catch (err) {
        respuestaElemento.innerText = "‚ùå Activa el micr√≥fono";
      }
    });

function enviarAudio(audioBlob, nombreArchivo) {
      const formData = new FormData();
      formData.append("file", audioBlob, nombreArchivo);
      respuestaElemento.innerText = "‚è≥ Procesando voz...";
      fetch("/voz", { method: "POST", body: formData })
      .then(res => res.json())
      .then(data => {
        if (data.texto && data.texto.trim() !== "") {
          respuestaElemento.innerText = "üß† Entend√≠: " + data.texto;
          if (btnGrabarIntento.style.display === "block") {
            validarIntento(btnGrabarIntento.dataset.respuesta || btnGrabarIntento.dataset.oracion, data.texto);
          } else {
            enviarPregunta(data.texto);
          }
        } else {
          respuestaElemento.innerText = "‚ùå No entend√≠ bien";
        }
      });
    }

    // --- L√ìGICA DE VOCALES ---
    async function iniciarSecuenciaPalabras(palabras) {
      palabrasPendientes = [...palabras];
      palabrasCompletadas = 0;
      contenedorEjercicios.style.display = "none";
      mensajeValidacion.innerText = "";
      await reproducirSiguientePalabra();
    }

    async function reproducirSiguientePalabra() {
      if (palabrasPendientes.length === 0) {
        respuestaElemento.innerText = "ü•≥ ¬°Completaste las 5 palabras!";
        contenedorEjercicios.style.display = "flex";
        btnGrabarIntento.style.display = "none";
        return;
      }
      const palabraActual = palabrasPendientes[0];
      respuestaElemento.innerText = `Escucha y repite: "${palabraActual}"`;
      
      const res = await fetch("/tts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ texto: `La palabra es: ${palabraActual}` })
      });
      const data = await res.json();
      if (data.audio_url) {
        const audio = new Audio(data.audio_url + "?t=" + new Date().getTime());
        audio.onended = () => {
          btnGrabarIntento.style.display = "block";
          btnGrabarIntento.dataset.respuesta = palabraActual;
          delete btnGrabarIntento.dataset.oracion;
        };
        audio.play();
      }
    }

    btnFrases.addEventListener("click", async () => {
      const res = await fetch("/palabras_vocales");
      const data = await res.json();
      if (data.palabras) iniciarSecuenciaPalabras(data.palabras);
    });

    // --- L√ìGICA DE ORACIONES ---
    function iniciarEjercicioVocal(vocal) {
      contenedorEjercicios.style.display = "none";
      btnGrabarIntento.style.display = "none";
      fetch("/oracion_vocal", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ vocal })
      })
      .then(res => res.json())
      .then(data => {
        const oracion = data.oracion;
        respuestaElemento.innerText = `Repite la oraci√≥n: "${oracion}"`;
        fetch("/tts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ texto: `Escucha y repite: ${oracion}` })
        })
        .then(res => res.json())
        .then(dataTTS => {
          const audio = new Audio(dataTTS.audio_url + "?t=" + new Date().getTime());
          audio.onended = () => {
            btnGrabarIntento.style.display = "block";
            btnGrabarIntento.dataset.oracion = oracion;
            delete btnGrabarIntento.dataset.respuesta;
          };
          audio.play();
        });
      });
    }

    btnOraciones.addEventListener("click", () => {
      const vocalAleatoria = ["a", "e", "i", "o", "u"][Math.floor(Math.random() * 5)];
      iniciarEjercicioVocal(vocalAleatoria);
    });

    // --- VALIDACI√ìN FINAL ---
    function validarIntento(respuestaCorrecta, intentoNi√±o) {
      fetch("/validar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ respuesta: respuestaCorrecta, intento: intentoNi√±o })
      })
      .then(res => res.json())
      .then(data => {
        mensajeValidacion.innerText = data.mensaje;
        const esCorrecto = data.correcto || ["muy bien", "perfecto", "lograste"].some(p => data.mensaje.toLowerCase().includes(p));
        
        fetch("/tts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ texto: data.mensaje })
        })
        .then(res => res.json())
        .then(dataTTS => {
          const audio = new Audio(dataTTS.audio_url + "?t=" + new Date().getTime());
          audio.onended = () => {
            if (!btnGrabarIntento.dataset.oracion) {
              if (esCorrecto) {
                palabrasPendientes.shift();
                palabrasCompletadas++;
                reproducirSiguientePalabra();
              } else {
                btnGrabarIntento.style.display = "block";
              }
            } else {
              if (esCorrecto) {
                setTimeout(() => {
                  contenedorEjercicios.style.display = "flex";
                  mensajeValidacion.innerText = "¬°Elige otro ejercicio!";
                }, 2000);
              } else {
                btnGrabarIntento.style.display = "block";
              }
            }
          };
          audio.play();
        });
      });
    }

    // --- PREGUNTAS NORMALES ---
    function enviarPregunta(pregunta) {
      fetch("/preguntar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pregunta })
      })
      .then(res => res.json())
      .then(data => {
        respuestaElemento.innerText = data.respuesta;
        if (data.audio_url) new Audio(data.audio_url).play();
      });
    }

    // --- GRABACI√ìN DEL INTENTO (BOT√ìN VERDE) ---
    btnGrabarIntento.addEventListener("pointerdown", async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const mimeType = isSafari ? "audio/mp4" : "audio/webm";
      mediaRecorderIntento = new MediaRecorder(stream, { mimeType });
      audioChunksIntento = [];
      mediaRecorderIntento.ondataavailable = e => audioChunksIntento.push(e.data);
      mediaRecorderIntento.onstop = () => {
        const blob = new Blob(audioChunksIntento, { type: mimeType });
        enviarIntento(blob, isSafari ? "intento.mp4" : "intento.webm");
      };
      mediaRecorderIntento.start();
      mensajeValidacion.innerText = "üéôÔ∏è ¬°Te escucho!...";
    });

    btnGrabarIntento.addEventListener("pointerup", () => mediaRecorderIntento?.stop());

    function enviarIntento(blob, nombre) {
      const formData = new FormData();
      formData.append("file", blob, nombre);
      fetch("/voz", { method: "POST", body: formData })
      .then(res => res.json())
      .then(data => {
        if (data.texto) {
          validarIntento(btnGrabarIntento.dataset.respuesta || btnGrabarIntento.dataset.oracion, data.texto);
        }
      });
    }
  </script>
</body>
</html>





















